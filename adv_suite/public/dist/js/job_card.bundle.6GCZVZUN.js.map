{
  "version": 3,
  "sources": ["../../../../../apps/adv_suite/adv_suite/public/js/job_card/job_card_custom.js"],
  "sourcesContent": ["frappe.ui.form.on('Job Card', {\n    onload: function(frm) {\n        console.log('onload');\n    },\n    onload_post_render: function(frm) {\n        // add_time_icon_to_table(frm, 'scheduled_time_logs');\n        add_time_icon_to_table(frm, 'time_logs');\n    }\n});\n\n// Funci\u00F3n para agregar el \u00EDcono de actualizar tiempo a una tabla\nfunction add_time_icon_to_table(frm, table_fieldname) {\n    let table_field = frm.fields_dict[table_fieldname];\n    if (!table_field) {\n        console.error(`No se encontr\u00F3 el campo ${table_fieldname}`);\n        return;\n    }\n\n    // Buscar el contenedor .form-column del campo\n    let form_column = table_field.$wrapper.closest('.form-column');\n\n    // Si no encontramos el .form-column, detener\n    if (!form_column.length) {\n        console.error('No se encontr\u00F3 el contenedor .form-column');\n        return;\n    }\n\n    // Buscar el label dentro del contenedor\n    let label_container = table_field.$wrapper.find('.control-label');\n    if (!label_container.length) {\n        console.error('No se encontr\u00F3 el contenedor del label (.control-label)');\n        return;\n    }\n\n    // Verificar si el \u00EDcono ya fue agregado\n    if (form_column.find('.time-update-icon').length) {\n        return; // Evitar duplicados\n    }\n\n    label_container.addClass('like-disabled-input');\n    label_container.css('position', 'relative');\n    label_container.css('width', '100%');\n\n    // Insertar el \u00EDcono fuera del label pero dentro del form-column\n    form_column.css('position', 'relative');\n    form_column.append(`\n        <button class=\"btn icon-btn time-update-icon\" style=\"position: absolute; top: 14px; right: 25px; transform: translateY(-50%);\" onmouseover=\"this.classList.add('btn-default')\" onmouseout=\"this.classList.remove('btn-default')\"  title=\"${__('Set time')}\">\n            <svg class=\"es-icon es-line icon-sm\" style=\"filter: opacity(0.55); stroke:none;\" aria-hidden=\"true\">\n                <use xlink:href=\"/assets/adv_suite/icons/icons.svg#icon-history\"></use>\n            </svg>\n        </button>\n    `);\n\n    // Manejar el clic en el \u00EDcono\n    form_column.find('.time-update-icon').on('click', function (event) {\n        handle_time_update_click(frm, table_fieldname);\n    });\n}\n\n// Funci\u00F3n para manejar el clic en el \u00EDcono de actualizar tiempo\nfunction handle_time_update_click(frm, table_fieldname) {\n    // Evitar que el evento de clic se propague al label\n    event.stopPropagation();\n\n    // Obtener el valor de expected_start_date seg\u00FAn la tabla\n    let expected_start_date;\n    if (table_fieldname === 'scheduled_time_logs') {\n        expected_start_date = frm.doc.expected_start_date;\n    } else if (table_fieldname === 'time_logs') {\n        expected_start_date = frm.doc.time_logs.length > 0 ? frm.doc.time_logs[0].from_time : frappe.datetime.now_datetime();\n    }\n\n    // Obtener el valor de time_required desde el BOM\n    frappe.db.get_doc('BOM', frm.doc.bom_no).then(bom => {\n        let operation = bom.operations.find(op => op.operation === frm.doc.operation);\n        if (!operation) {\n            frappe.msgprint(__('No se encontr\u00F3 la operaci\u00F3n en el BOM.'));\n            return;\n        }\n        let time_required = operation.time_in_mins;\n\n        // Obtener los registros actuales de la tabla\n        let time_logs = frm.doc[table_fieldname] || [];\n\n        // Limpiar la tabla\n        frm.clear_table(table_fieldname);\n\n        if (table_fieldname === 'scheduled_time_logs') {\n            handle_scheduled_time_logs(frm, expected_start_date, time_required, time_logs);\n        } else if (table_fieldname === 'time_logs') {\n            handle_time_logs(frm, expected_start_date, time_required, time_logs);\n        }\n\n        // Refrescar la tabla\n        frm.refresh_field(table_fieldname);\n\n        // Mostrar una notificaci\u00F3n tipo alert\n        frappe.show_alert({\n            message: __('Time successfully adjusted'),\n            indicator: 'green'\n        });\n    });\n}\n\n// Funci\u00F3n para manejar la l\u00F3gica espec\u00EDfica de scheduled_time_logs\nfunction handle_scheduled_time_logs(frm, expected_start_date, time_required, time_logs) {\n    if (time_logs.length === 0 || time_logs.length === 1) {\n        // Si la tabla est\u00E1 vac\u00EDa o tiene 1 fila, agregar o sustituir una fila\n        let from_time = expected_start_date;\n        let to_time = add_minutes_to_datetime(from_time, time_required);\n\n        frm.add_child('scheduled_time_logs', {\n            from_time: from_time,\n            to_time: to_time,\n            time_in_mins: time_required\n        });\n    } else {\n        // Si la tabla tiene n filas, distribuir los minutos requeridos uniformemente\n        let minutes_per_row = time_required / time_logs.length;\n        let current_time = expected_start_date;\n\n        time_logs.forEach((log, index) => {\n            let from_time = current_time;\n            let to_time = add_minutes_to_datetime(from_time, minutes_per_row);\n\n            frm.add_child('scheduled_time_logs', {\n                from_time: from_time,\n                to_time: to_time,\n                time_in_mins: minutes_per_row\n            });\n\n            // La fecha de inicio del siguiente rengl\u00F3n es un segundo despu\u00E9s de la fecha to_time del rengl\u00F3n anterior\n            current_time = add_seconds_to_datetime(to_time, 1);\n        });\n    }\n}\n\n// Funci\u00F3n para manejar la l\u00F3gica espec\u00EDfica de time_logs\nfunction handle_time_logs(frm, expected_start_date, time_required, time_logs) {\n    let employees = cur_frm.fields_dict['employee'].value || [];\n    let employee = employees.length > 0 ? employees[0].employee : null;\n    let total_completed_qty = frm.doc.total_completed_qty;\n\n    if (time_logs.length === 0 || time_logs.length === 1) {\n        // Si la tabla est\u00E1 vac\u00EDa o tiene 1 fila, agregar o sustituir una fila\n        let from_time = expected_start_date;\n        let to_time = add_minutes_to_datetime(from_time, time_required);\n\n        frm.add_child('time_logs', {\n            from_time: from_time,\n            to_time: to_time,\n            time_in_mins: time_required,\n            employee: employee,\n            completed_qty: total_completed_qty\n        });\n\n        // Establecer los campos del documento principal\n        frm.set_value('actual_start_date', from_time);\n        frm.set_value('actual_end_date', to_time);\n        frm.set_value('total_time_in_mins', time_required);\n    } else {\n        // Si la tabla tiene n filas, distribuir los minutos requeridos uniformemente\n        let minutes_per_row = time_required / time_logs.length;\n        let current_time = expected_start_date;\n\n        time_logs.forEach((log, index) => {\n            let from_time = current_time;\n            let to_time = add_minutes_to_datetime(from_time, minutes_per_row);\n\n            frm.add_child('time_logs', {\n                from_time: from_time,\n                to_time: to_time,\n                time_in_mins: minutes_per_row,\n                employee: log.employee || employee,\n                completed_qty: index === time_logs.length - 1 ? total_completed_qty : 0\n            });\n\n            // La fecha de inicio del siguiente rengl\u00F3n es un segundo despu\u00E9s de la fecha to_time del rengl\u00F3n anterior\n            current_time = add_seconds_to_datetime(to_time, 1);\n        });\n\n        // Establecer los campos del documento principal\n        frm.set_value('actual_start_date', expected_start_date);\n        frm.set_value('actual_end_date', current_time);\n        frm.set_value('total_time_in_mins', time_required);\n    }\n}\n\n// Funci\u00F3n personalizada para agregar minutos a una fecha y hora\nfunction add_minutes_to_datetime(datetime, minutes) {\n    return add_seconds_to_datetime(datetime, minutes * 60);\n}\n\n// Funci\u00F3n personalizada para agregar segundos a una fecha y hora\nfunction add_seconds_to_datetime(datetime, seconds) {\n    let date = new Date(datetime);\n    date.setSeconds(date.getSeconds() + seconds); // Sumar segundos a la fecha\n    return format_datetime(date);\n}\n\n// Funci\u00F3n para formatear la fecha y hora sin cambiar la zona horaria\nfunction format_datetime(date) {\n    let year = date.getFullYear();\n    let month = ('0' + (date.getMonth() + 1)).slice(-2);\n    let day = ('0' + date.getDate()).slice(-2);\n    let hours = ('0' + date.getHours()).slice(-2);\n    let minutes = ('0' + date.getMinutes()).slice(-2);\n    let seconds = ('0' + date.getSeconds()).slice(-2);\n    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;\n}"],
  "mappings": "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",
  "names": ["event"]
}
